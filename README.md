# spring cloud 学习

## 一.  eureka服务服务治理体系

服务治理是微服务架构中最为核心和基础的模块，它主要用来实现各个微服务实例的自动化注册和发现。

Spring Cloud Eureka是Spring Cloud Netflix微服务套件中的一部分，它基于Netflix Eureka做了二次封装。主要负责完成微服务架构中的服务治理功能。

Eureka的三个核心角色：服务注册中心、服务提供者和服务消费者

### 基础架构

**服务注册中心:** Eureka server 即 Eureka服务端，提供服务注册与发现的功能,具有以下几个功能

1. **服务下线**

   在客户端程序中，当服务实例进行正常的关闭操作时，它会出发一个服务下线的REST请求给Eureka Server，告诉服务注册中心“我要下线了”。服务端在接受到请求后，讲该服务状态置为下线并把该下线事件传播出去

2. **失效剔除**

   有时服务实例不是正常下线的，而服务注册中心并未收到“服务下线”的请求。为了从服务列表讲这些无法提供服务的实例剔除，Eureka Server在启动的时候会创建一个定时任务，默认每隔60秒, 将当前清单中超时(默认90秒)没有续约的服务剔除出去。

3. **自我保护**

   在服务注册中心的信息面板中出现类似下面的红色警告信息：

   ![技术分享图片](http://image.mamicode.com/info/201712/20180111010516773769.png)

   实际上，该警告就出发了Eureka Server的自我保护机制。Eureka Server在运行期间，会统计心跳失败的比例在15分钟之内是大于15%，如果出现大于的情况Eureka Server会将当前实例注册信息保护起来，让这些实例不会过期，尽可能保护这些注册信息。

   在本地调试的时候很容易触发注册中心的保护机制，这会使得注册中心维护的服务实例不那么准确。所以我们再本地进行开发的时候，可以通过设置参数

   ==eureka.server.enable-self-preservation=false== 来关闭保护机制，保证注册中心将不可用的实例正确剔除。

**服务提供者:** 提供服务的应用，可以是Spring Boot应用，也可以是其他技术平台且遵循Eureka通信机制的应用。它将自己提供的服务注册到Eureka，以供其他应用发现。

* **服务注册:**  在服务注册时，需要确认一下eureka.client.registerwith-eurek=ture参数是否正确，默认是true，若设置为false将不会启动注册操作。

* **服务同步:**  两个服务提供者的服务信息是一样的

* **服务续约:**  主要看两个主要属性

  ```properties
  #定义服务续约任务的调用间隔时间，默认为30秒
  eureka.instance.lease-renewal-interval-in-seconds=30
  #定义服务失效的时间，默认为90秒
  eureka.instance.lease-expiration-duration-in-secodes=90
  ```

**服务消费者：**消费者应用从服务注册中心获取服务列表，从而使消费者可以知道去何处调用所需要的服务。

1. **获取服务**

   当服务消费者启动的时候，会发送一个REST请求给服务注册中心，来获取服务注册清单。为了性能考虑，Eureka Server会维护一份只读的服务清单来返回给客户端，同时该缓存清单会每隔30秒更新一次。获取服务是服务消费者的基础，所以必须确保 ==eureka.client.fetch-registry=ture== (该值默认是true)。可以通过 ==eureka.client.registry-fetch-interval-seconds=30== 参数修改缓存清单的更新时间。

 2. **服务调用**

    服务消费者在获取的服务清单后，通过服务名可以获得具体提供服务的实例名和该实例的元数据信息。因为有这些服务实例的详细信息，所以客户端可以根据自己的需要决定具体调用哪个实例，在`Ribbon`中会默认采用轮询的方式进行调用，从而实现客户端的负载均衡。对于访问实例选择，Eureka中有Region和Zone的概念，一个Region中可以包含多个Zone，每个服务客户端需要被注册到一个Zone中，所以每个客户端对应一个Region和一个Zone。





